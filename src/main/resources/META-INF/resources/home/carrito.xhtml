<?xml version="1.0" encoding="UTF-8"?>
<ui:composition lang="es"
                xmlns:f="jakarta.faces.core"
                xmlns:h="jakarta.faces.html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/template/main.xhtml">

    <ui:define name="contenido">
        <h:outputStylesheet>
            /* <![CDATA[ */
            .cart-container { padding: 40px 0; background-color: #f8fafc; min-height: 80vh; }

            /* Estilo de Tarjetas de Producto */
            .cart-item-card {
                background: #ffffff;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                transition: transform 0.2s;
            }
            .cart-item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

            .product-img {
                width: 100px; height: 100px;
                object-fit: contain;
                border-radius: 8px;
                background: #f1f5f9;
            }

            /* Sidebar de Totales */
            .summary-card {
                background: #1e293b;
                color: #ffffff;
                border-radius: 16px;
                padding: 30px;
                position: sticky;
                top: 20px;
            }

            .currency-badge {
                background: rgba(251, 191, 36, 0.1);
                color: #fbbf24;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 0.8rem;
                font-weight: bold;
            }

            .qty-control {
                border: 1px solid #e2e8f0;
                border-radius: 25px;
                padding: 5px;
                background: #f8fafc;
            }

            .price-main { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
            .price-usd { font-size: 0.85rem; color: #64748b; }
            /* ]]> */
        </h:outputStylesheet>

        <div class="cart-container">
            <div class="container">
                <h:form id="formCarrito">
                    <p:growl id="msgs" showDetail="true" />

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h2 class="fw-bold m-0">Bolsa de Compras</h2>
                                <h:outputText value="#{carroBean.pedido.detallepedidos.size()} productos" styleClass="text-muted" />
                            </div>

                            <p:outputPanel id="cartPanel">
                                <h:panelGroup rendered="#{empty carroBean.pedido.detallepedidos}">
                                    <div class="text-center py-5 bg-white rounded-4 border">
                                        <i class="pi pi-shopping-cart text-muted mb-3" style="font-size: 3rem;"></i>
                                        <h3 class="text-secondary">Tu carrito está vacío</h3>
                                        <p:button outcome="/home/tienda.xhtml" value="Explorar Productos"
                                                  styleClass="ui-button-outlined ui-button-primary mt-3" />
                                    </div>
                                </h:panelGroup>

                                <ui:repeat value="#{carroBean.pedido.detallepedidos}" var="item">
                                    <div class="cart-item-card d-flex align-items-center gap-4">
                                        <p:graphicImage value="#{configBean.urlImagenes}#{item.producto.imagen}" styleClass="product-img" />

                                        <div class="flex-grow-1">
                                            <h5 class="fw-bold mb-1">#{item.producto.nombre}</h5>
                                            <p class="text-muted small mb-2">Ref: SKU-#{item.producto.idProducto}</p>

                                            <div class="d-flex align-items-baseline gap-2">
                                                <h:outputText value="#{item.producto.precio}" styleClass="price-main">
                                                    <f:convertNumber type="currency" currencySymbol="$" />
                                                </h:outputText>
                                                <span class="price-usd">(USD $#{String.format('%.2f', item.producto.precio/tiendaBean.valorDolar)})</span>
                                            </div>
                                        </div>

                                        <div class="qty-control d-flex align-items-center gap-3">
                                            <p:commandButton icon="pi pi-minus" styleClass="ui-button-rounded ui-button-flat ui-button-plain"
                                                             actionListener="#{carroBean.decreamentarCantidad(item.producto)}"
                                                             update=":formCarrito:cartPanel :formCarrito:summary :cartWrapper" />

                                            <h:outputText value="#{item.cantidad}" styleClass="fw-bold fs-5" />

                                            <p:commandButton icon="pi pi-plus" styleClass="ui-button-rounded ui-button-flat ui-button-plain"
                                                             actionListener="#{carroBean.incrementarCantidad(item.producto)}"
                                                             update=":formCarrito:cartPanel :formCarrito:summary :cartWrapper" />
                                        </div>

                                        <div class="text-end" style="min-width: 120px;">
                                            <h:outputText value="#{item.producto.precio * item.cantidad}" styleClass="fw-bold fs-5 d-block">
                                                <f:convertNumber type="currency" currencySymbol="$" />
                                            </h:outputText>
                                            <p:commandLink value="Eliminar" actionListener="#{carroBean.removeItemFromCart(item)}"
                                                           update=":formCarrito:cartPanel :formCarrito:summary :cartWrapper"
                                                           styleClass="text-danger small fw-bold text-decoration-none" />
                                        </div>
                                    </div>
                                </ui:repeat>
                            </p:outputPanel>
                        </div>

                        <div class="col-lg-4">
                            <p:outputPanel id="summary">
                                <h:panelGroup layout="block" styleClass="summary-card shadow-lg"
                                              rendered="#{not empty carroBean.pedido.detallepedidos}">

                                    <h4 class="fw-bold mb-4">Resumen de Orden</h4>

                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-light opacity-75">Subtotal</span>
                                        <h:outputText value="#{carroBean.total}">
                                            <f:convertNumber type="currency" currencySymbol="$" />
                                        </h:outputText>
                                    </div>

                                    <div class="d-flex justify-content-between mb-4">
                                        <span class="text-light opacity-75">Envío</span>
                                        <span class="text-success fw-bold">Gratis</span>
                                    </div>

                                    <hr class="border-secondary" />

                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-end mb-1">
                                            <span class="fs-5">Total CLP</span>
                                            <h:outputText value="#{carroBean.total}" styleClass="fs-3 fw-bold text-warning">
                                                <f:convertNumber type="currency" currencySymbol="$" />
                                            </h:outputText>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="currency-badge">USD (Dólar hoy: $#{tiendaBean.valorDolar})</span>
                                            <h:outputText value="#{carroBean.total/tiendaBean.valorDolar}" styleClass="fs-5 opacity-75">
                                                <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2" />
                                            </h:outputText>
                                        </div>
                                    </div>

                                    <p:linkButton outcome="/home/checkout.xhtml" value="Finalizar Compra"
                                                  icon="pi pi-credit-card"
                                                  styleClass="ui-button-warning w-100 py-3 fw-bold fs-5 rounded-pill shadow" />

                                    <div class="text-center mt-3">
                                        <i class="pi pi-shield text-muted me-2"></i>
                                        <span class="small text-muted">Pago seguro garantizado</span>
                                    </div>

                                </h:panelGroup>
                            </p:outputPanel>
                        </div>
                    </div>

                    <p:poll interval="30" listener="#{tiendaBean.checkValorDolar}" update="summary"
                            stop="#{tiendaBean.valorDolar gt 0}" />
                </h:form>
            </div>
        </div>
    </ui:define>
</ui:composition>