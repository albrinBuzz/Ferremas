<ui:composition lang="es"
                xmlns:f="jakarta.faces.core"
                xmlns:h="jakarta.faces.html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/template/main.xhtml">

    <ui:define name="contenido">
        <h:form id="formPedidos">
            <p:growl id="msgs" showDetail="true" life="4000" />

            <div class="p-mb-4 animated fadeIn">
                <h1 class="fancy-title">
                    <i class="pi pi-wallet p-mr-2 text-primary"></i>
                    Gestión de Transferencias - Sucursal #{pedidoBean.sucursal.nombre}
                </h1>
                <p class="text-color-secondary">Administre los estados de pedidos y valide comprobantes de pago.</p>
            </div>

            <p:dataTable id="tablaPedidos" value="#{transferenciasBean.pedidos}" var="pedido"
                         paginator="true" rows="10"
                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                         currentPageReportTemplate="{startRecord}-{endRecord} de {totalRecords} pedidos"
                         emptyMessage="No hay pedidos con transferencias pendientes"
                         widgetVar="pedidoTable" rowKey="#{pedido.idPedido}"
                         styleClass="fancy-datatable shadow-2"
                         rowStyleClass="#{pedidoBean.obtenerEstiloFila(pedido)}">

                <f:facet name="header">
                    <div class="p-d-flex p-jc-between p-ai-center">
                        <span class="text-xl font-bold">Listado General</span>
                        <span class="p-input-icon-left">
                            <i class="pi pi-search" />
                            <p:inputText id="globalFilter" onkeyup="PF('pedidoTable').filter()"
                                         placeholder="Buscar pedido, RUT..." style="width:250px" />
                        </span>
                    </div>
                </f:facet>

                <p:column style="width:3rem" exportable="false">
                    <p:rowToggler/>
                </p:column>

                <p:column headerText="Orden #" filterBy="#{pedido.idPedido}" width="100">
                    <h:outputText value="#{pedido.idPedido}" styleClass="font-bold text-primary" />
                </p:column>

                <p:column headerText="Fecha Emisión" sortBy="#{pedido.fecha}">
                    <h:outputText value="#{pedido.fecha}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                    </h:outputText>
                </p:column>

                <p:column headerText="Estado Pedido" filterBy="#{pedido.estadopedido.nombre}" filterMatchMode="exact">
                    <f:facet name="filter">
                        <p:selectOneMenu onchange="PF('pedidoTable').filter()" styleClass="w-full">
                            <f:selectItem itemLabel="Todos los estados" itemValue="#{null}" noSelectionOption="true" />
                            <f:selectItems value="#{transferenciasBean.estados}" var="est"
                                           itemLabel="#{est.nombre}" itemValue="#{est.nombre}" />
                        </p:selectOneMenu>
                    </f:facet>
                    <p:tag severity="#{pedido.estadopedido.nombre eq 'Completado' ? 'success' : 'warning'}"
                           value="#{pedido.estadopedido.nombre}" rounded="true"/>
                </p:column>

                <p:column headerText="Contacto Cliente">
                    <div class="p-d-flex p-flex-column">
                        <h:panelGroup rendered="#{not empty pedidoBean.getCorreosCliente(pedido.rutcliente)}">
                            <i class="pi pi-envelope text-xs p-mr-1"></i>
                            <h:outputText value="#{pedidoBean.getCorreosCliente(pedido.rutcliente)[0]}" styleClass="text-sm"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{not empty pedidoBean.getTelefonosCliente(pedido.rutcliente)}">
                            <i class="pi pi-phone text-xs p-mr-1 p-mt-1"></i>
                            <h:outputText value="#{pedidoBean.getTelefonosCliente(pedido.rutcliente)[0]}" styleClass="text-sm"/>
                        </h:panelGroup>
                    </div>
                </p:column>

                <p:column headerText="Monto Total" sortBy="#{pedido.total}">
                    <h:outputText value="#{pedido.total}" styleClass="font-bold">
                        <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="0" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Gestión" width="120" styleClass="p-text-center">
                    <p:commandButton icon="pi pi-pencil"
                                     action="#{transferenciasBean.editarEstado(pedido)}"
                                     update=":formPedidos:dlgEstado"
                                     oncomplete="PF('dlgEstado').show()"
                                     styleClass="p-button-rounded p-button-outlined p-mr-2" />

                    <p:commandButton icon="pi pi-trash"
                                     action="#{pedidoBean.eliminarPedido(pedido)}"
                                     update="tablaPedidos :formPedidos:msgs"
                                     styleClass="p-button-rounded p-button-danger p-button-outlined">
                        <p:confirm header="Confirmación" message="¿Eliminar el pedido ##{pedido.idPedido}?" icon="pi pi-exclamation-triangle" />
                    </p:commandButton>
                </p:column>

                <p:rowExpansion>
                    <div class="p-p-3 surface-50 border-round shadow-inner">
                        <h3 class="p-mt-0 p-mb-3 text-700">Comprobantes Adjuntos</h3>
                        <p:dataTable value="#{pedido.transferencias}" var="trn" size="small" styleClass="fancy-subtable">
                            <p:column headerText="ID Trans." width="80"><h:outputText value="#{trn.idtransferencia}" /></p:column>

                            <p:column headerText="Monto Informado">
                                <h:outputText value="#{trn.monto}" styleClass="font-bold text-orange-600">
                                    <f:convertNumber type="currency" currencySymbol="$" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Fecha Registro">
                                <h:outputText value="#{trn.fecha}"><f:convertDateTime pattern="dd-MM-yyyy" /></h:outputText>
                            </p:column>

                            <p:column headerText="Estado Pago">
                                <p:badge value="#{trn.estadotransferencia.nombre}"
                                         severity="#{trn.estadotransferencia.nombre eq 'Validado' ? 'success' : 'info'}" />
                            </p:column>

                            <p:column headerText="Comprobante" width="100" styleClass="p-text-center">
                                <p:commandButton icon="pi pi-eye" title="Ver Comprobante"
                                                 actionListener="#{transferenciasBean.verComprobante(trn)}"
                                                 process="@this"
                                                 update="comprobanteDialog"
                                                 oncomplete="PF('comprobanteDialogWidget').show()" />
                            </p:column>

                            <p:column headerText="Acción">
                                <p:commandButton value="Validar" icon="pi pi-check-circle"
                                                 action="#{transferenciasBean.editarEstadoTransa(trn)}"
                                                 update=":formPedidos:dlgEstadoTransa"
                                                 oncomplete="PF('dlgEstadoTransa').show()"
                                                 styleClass="p-button-sm p-button-success p-button-text" />
                            </p:column>
                        </p:dataTable>
                    </div>
                </p:rowExpansion>
            </p:dataTable>

            <p:dialog header="Actualizar Pedido" widgetVar="dlgEstado" modal="true" width="400" responsive="true" id="dlgEstado">
                <div class="ui-fluid">
                    <div class="p-field p-mb-3">
                        <p:outputLabel value="Nuevo Estado para Pedido ##{transferenciasBean.pedidoSeleccionado.idPedido}" />
                        <p:selectOneMenu id="nuevoEstado" value="#{transferenciasBean.estadoSeleccionadoID}">
                            <f:selectItems value="#{transferenciasBean.estados}" var="e"
                                           itemLabel="#{e.nombre}" itemValue="#{e.idEstadopedido}" />
                        </p:selectOneMenu>
                    </div>
                </div>
                <f:facet name="footer">
                    <p:commandButton value="Guardar Cambios" icon="pi pi-check"
                                     action="#{transferenciasBean.guardarEstadoEstadoPedio}"
                                     update="tablaPedidos msgs" oncomplete="PF('dlgEstado').hide()" />
                </f:facet>
            </p:dialog>

            <p:dialog header="Validación de Transferencia" widgetVar="dlgEstadoTransa" modal="true" width="450" id="dlgEstadoTransa">
                <h:panelGroup id="pnlValidacionInterna" layout="block" rendered="#{not empty transferenciasBean.transferenciaSeleccionada}">
                    <div class="ui-fluid">
                        <p:staticMessage severity="info" summary="Atención" detail="Revise el comprobante antes de validar." styleClass="p-mb-3"/>

                        <div class="p-field p-mb-3">
                            <p:outputLabel value="ID Transferencia: #{transferenciasBean.transferenciaSeleccionada.idtransferencia}" styleClass="font-bold p-d-block"/>
                            <p:outputLabel value="Mensaje del Cliente:" styleClass="text-sm text-secondary p-mt-2"/>
                            <div class="p-p-2 bg-gray-100 border-round italic" style="border-left: 4px solid #fbbf24; background-color: #f8f9fa;">
                                "#{empty transferenciasBean.transferenciaSeleccionada.comentario ? 'Sin comentarios' : transferenciasBean.transferenciaSeleccionada.comentario}"
                            </div>
                        </div>

                        <div class="p-field p-mb-3">
                            <p:outputLabel for="nuevoEstadoTransa" value="Nuevo Estado:" styleClass="font-bold"/>
                            <p:selectOneMenu id="nuevoEstadoTransa" value="#{transferenciasBean.estadoTransaID}" styleClass="p-mt-1">
                                <f:selectItems value="#{transferenciasBean.estadosTransa}" var="et"
                                               itemLabel="#{et.nombre}" itemValue="#{et.idestadotrnsf}" />
                                <p:ajax update="pnlValidacionInterna" process="@this" />
                            </p:selectOneMenu>
                        </div>

                        <div class="p-field">
                            <p:outputLabel for="obsAdmin" value="Observación de Ferremas (Feedback):" styleClass="font-bold"/>
                            <p:inputTextarea id="obsAdmin"
                                             value="#{transferenciasBean.transferenciaSeleccionada.observacionAdmin}"
                                             rows="4"
                                             placeholder="Escriba aquí el motivo del rechazo o nota de aprobación..."
                                             required="#{transferenciasBean.estadoTransaID == 2}"
                                             requiredMessage="Debe indicar el motivo del rechazo."/>

                            <h:panelGroup id="obsAyuda">
                                <small class="p-d-block p-mt-1 #{transferenciasBean.estadoTransaID == 2 ? 'text-danger font-bold' : 'text-muted'}">
                                    #{transferenciasBean.estadoTransaID == 2 ? '⚠️ Motivo obligatorio para notificar rechazo.' : 'ℹ️ Este texto se enviará al correo del cliente.'}
                                </small>
                            </h:panelGroup>
                        </div>
                    </div>
                </h:panelGroup>

                <f:facet name="footer">
                    <p:commandButton value="Confirmar Pago"
                                     icon="pi pi-verified"
                                     action="#{transferenciasBean.guardarEstadoEstadoTransa}"
                                     update="tablaPedidos msgs pnlValidacionInterna"
                                     oncomplete="if(!args.validationFailed) PF('dlgEstadoTransa').hide()"
                                     styleClass="p-button-success" />
                </f:facet>
            </p:dialog>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
                <p:commandButton value="Sí, eliminar" type="button" styleClass="ui-confirmdialog-yes ui-button-danger" />
            </p:confirmDialog>
        </h:form>

        <p:dialog id="comprobanteDialog" widgetVar="comprobanteDialogWidget" modal="true"
                  header="Visor de Comprobante" responsive="true" width="550" styleClass="fancy-dialog-viewer">
            <p:scrollPanel mode="native" style="max-height: 70vh; border: none;">
                <h:panelGroup id="displayTransfer" layout="block" rendered="#{not empty transferenciasBean.transferenciaSeleccionada}">
                    <div class="p-d-flex p-ai-center p-jc-between p-p-3 border-bottom-1 border-200">
                        <span class="font-bold"><i class="pi pi-file p-mr-1"></i> #{transferenciasBean.transferenciaSeleccionada.comprobante}</span>
                        <p:button icon="pi pi-external-link" title="Abrir en pestaña nueva"
                                  href="#{configBean.urlImagenes}transferencias/#{transferenciasBean.transferenciaSeleccionada.comprobante}"
                                  target="_blank" styleClass="p-button-rounded p-button-text"/>
                    </div>
                    <div class="p-text-center p-p-3 bg-gray-100">
                        <p:graphicImage url="#{configBean.urlImagenes}transferencias/#{transferenciasBean.transferenciaSeleccionada.comprobante}"
                                        rendered="#{not empty transferenciasBean.transferenciaSeleccionada.comprobante}"
                                        styleClass="shadow-5 border-round"
                                        style="max-width: 100%; max-height: 50vh;"/>
                    </div>
                    <div class="p-p-3 text-sm">
                        <p:outputLabel value="Comentario del cliente:" styleClass="font-bold p-d-block"/>
                        <h:outputText value="#{empty transferenciasBean.transferenciaSeleccionada.comentario ? 'Sin comentarios' : transferenciasBean.transferenciaSeleccionada.comentario}" styleClass="italic"/>
                    </div>
                </h:panelGroup>
            </p:scrollPanel>
        </p:dialog>

        <style type="text/css">
            .fancy-title { font-size: 1.8rem; font-weight: 700; color: #333; }
            .fancy-datatable .ui-datatable-header { background: #f8f9fa; padding: 1rem; border-top-left-radius: 10px; border-top-right-radius: 10px; }
            .fancy-subtable { box-shadow: none !important; }
            .fancy-subtable thead th { background: #6a5acd !important; color: white !important; }
            .border-left-3 { border-left: 4px solid !important; }
            .border-orange-500 { border-left-color: #f59e0b !important; }
            .fancy-dialog-viewer .ui-dialog-content { padding: 0 !important; }
        </style>
    </ui:define>
</ui:composition>