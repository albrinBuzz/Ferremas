<ui:composition lang="es"
                xmlns:f="jakarta.faces.core"
                xmlns:h="jakarta.faces.html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/template/main.xhtml">

    <ui:define name="contenido">
        <h:outputStylesheet>
            /* <![CDATA[ */
            .product-admin-container { padding: 25px; max-width: 1300px; margin: 0 auto; }

            /* Estilo de la imagen en tabla */
            .img-thumbnail-custom {
                width: 45px; height: 45px;
                object-fit: contain;
                background: #fff;
                border-radius: 8px;
                padding: 4px;
                border: 1px solid rgba(255,255,255,0.1);
            }

            /* Tabla Dark Estilizada */
            .ui-datatable tr { background: #161b22 !important; border-bottom: 1px solid rgba(255,255,255,0.05) !important; }
            .ui-datatable tr:hover { background: rgba(251, 191, 36, 0.03) !important; }
            .ui-datatable thead th {
                background: #1c2128 !important;
                text-transform: uppercase;
                font-size: 0.7rem;
                letter-spacing: 1px;
                color: rgba(255,255,255,0.6) !important;
            }

            .price-tag { color: #fbbf24; font-weight: 800; font-size: 0.9rem; }
            .category-badge {
                background: rgba(59, 130, 246, 0.1) !important;
                color: #60a5fa !important;
                border: 1px solid rgba(96, 165, 250, 0.2) !important;
                font-size: 0.65rem !important;
                padding: 2px 8px !important;
            }

            /* Toolbars y Inputs */
            .search-bar {
                background: #0d1117 !important;
                border: 1px solid rgba(255,255,255,0.1) !important;
                color: white !important;
                border-radius: 10px !important;
                width: 300px;
            }
            /* ]]> */
        </h:outputStylesheet>

        <div class="product-admin-container">
            <h:form id="form">
                <p:growl id="messages" showDetail="true" />

                <div class="d-flex justify-content-between align-items-end mb-4">
                    <div>
                        <h2 class="text-white fw-black m-0">Inventario de Bodega</h2>
                        <p class="text-muted small m-0">Gestión de stock, precios y catalogación de productos.</p>
                    </div>
                    <div class="d-flex gap-2">
                        <p:commandButton value="NUEVO PRODUCTO" icon="pi pi-plus"
                                         actionListener="#{adminBean.openNew}"
                                         update=":dialogs:manage-product-content"
                                         oncomplete="PF('manageProductDialog').show()"
                                         styleClass="ui-button-warning fw-bold rounded-pill shadow" />

                        <p:commandButton id="delete-products-button" icon="pi pi-trash"
                                         value="Eliminar"
                                         actionListener="#{adminBean.deleteSelectedProducts}"
                                         styleClass="ui-button-danger ui-button-flat"
                                         disabled="#{!adminBean.hasSelectedProducts()}" update="@this">
                            <p:confirm header="Confirmación" message="¿Eliminar los productos seleccionados?" icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                    </div>
                </div>

                <p:dataTable id="dt-products" widgetVar="dtProducts" var="product"
                             value="#{adminBean.productos}" paginator="true" rows="10"
                             selection="#{adminBean.productoSeleccionado}" rowKey="#{product.idProducto}"
                             paginatorPosition="bottom" reflow="true">

                    <f:facet name="header">
                        <div class="d-flex justify-content-start py-2">
                            <span class="ui-input-icon-left">
                                <i class="pi pi-search text-warning" />
                                <p:inputText id="globalFilter" onkeyup="PF('dtProducts').filter()"
                                             placeholder="Buscar por nombre o marca..." styleClass="search-bar" />
                            </span>
                        </div>
                    </f:facet>

                    <p:ajax event="rowSelect" update=":form:delete-products-button" />
                    <p:ajax event="rowUnselect" update=":form:delete-products-button" />

                    <p:column selectionMode="multiple" exportable="false" style="width: 3rem; text-align: center;" />

                    <p:column headerText="Imagen" style="width: 80px; text-align: center;">
                        <p:graphicImage url="/imagenes/#{product.imagen}" styleClass="img-thumbnail-custom shadow-sm"
                                        rendered="#{not empty product.imagen}" />
                        <i class="fas fa-box text-muted opacity-50" style="font-size: 1.5rem" rendered="#{empty product.imagen}" />
                    </p:column>

                    <p:column headerText="Producto" sortBy="#{product.nombre}" filterBy="#{product.nombre}">
                        <div class="d-flex flex-column">
                            <h:outputText value="#{product.nombre}" styleClass="fw-bold text-white" style="font-size: 0.85rem;" />
                            <h:outputText value="#{product.marca}" styleClass="text-warning opacity-75" style="font-size: 0.7rem; text-transform: uppercase;" />
                        </div>
                    </p:column>

                    <p:column headerText="Descripción" style="width: 25%">
                        <h:outputText value="#{product.descripcion}" styleClass="text-muted small text-truncate d-block" style="max-width: 250px;" />
                    </p:column>

                    <p:column headerText="Categoría" sortBy="#{product.categoria.nombre}">
                        <p:tag value="#{product.categoria.nombre}" styleClass="category-badge" />
                    </p:column>

                    <p:column headerText="Precio" sortBy="#{product.precio}" style="width: 120px;">
                        <h:outputText value="#{product.precio}" styleClass="price-tag">
                            <f:convertNumber currencySymbol="$" type="currency" locale="es_CL" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Acciones" exportable="false" style="width: 100px; text-align: center;">
                        <p:commandButton icon="pi pi-pencil" update=":dialogs:manage-product-content"
                                         oncomplete="PF('manageProductDialog').show()"
                                         styleClass="ui-button-text ui-button-warning p-0" process="@this">
                            <f:setPropertyActionListener value="#{product}" target="#{adminBean.productoSeleccionado}" />
                        </p:commandButton>
                        <p:commandButton icon="pi pi-trash" oncomplete="PF('deleteProductDialog').show()"
                                         styleClass="ui-button-text ui-button-danger p-0 ms-3" process="@this">
                            <f:setPropertyActionListener value="#{product}" target="#{adminBean.productoSeleccionado}" />
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
            </h:form>

            <h:form id="dialogs" enctype="multipart/form-data">
                <p:dialog header="Ficha Técnica de Producto" widgetVar="manageProductDialog"
                          modal="true" responsive="true" width="600" styleClass="dark-dialog">

                    <p:outputPanel id="manage-product-content" class="ui-fluid p-3">
                        <h:panelGroup layout="block" styleClass="row" rendered="#{not empty adminBean.productoSeleccionado}">


                            <div class="col-12 text-center mb-4">
                                <p:graphicImage url="/imagenes/#{adminBean.productoSeleccionado.imagen}"
                                                style="max-height: 150px; border-radius: 12px; background: #fff; padding: 10px;"
                                                rendered="#{not empty adminBean.productoSeleccionado.imagen}" />
                            </div>

                            <div class="col-md-8 mb-3">
                                <p:outputLabel for="name" value="Nombre del Producto" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:inputText id="name" value="#{adminBean.productoSeleccionado.nombre}" required="true" styleClass="search-bar w-100" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <p:outputLabel for="price" value="Precio (USD)" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:inputNumber id="price" value="#{adminBean.productoSeleccionado.precio}"
                                               symbol="$" decimalSeparator="." thousandSeparator="," styleClass="search-bar w-100" />
                            </div>

                            <div class="col-12 mb-3">
                                <p:outputLabel for="description" value="Descripción Técnica" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:inputTextarea id="description" value="#{adminBean.productoSeleccionado.descripcion}" rows="2" styleClass="search-bar w-100" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <p:outputLabel for="marca" value="Marca / Fabricante" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:inputText id="marca" value="#{adminBean.productoSeleccionado.marca}" styleClass="search-bar w-100" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <p:outputLabel for="categoriaProducto" value="Categoría" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:selectOneMenu id="categoriaProducto" value="#{adminBean.categoria}" styleClass="search-bar w-100">
                                    <f:selectItems value="#{adminBean.categorias}" var="cat" itemLabel="#{cat.nombre}" itemValue="#{cat.nombre}" />
                                </p:selectOneMenu>
                            </div>

                            <div class="col-12 mt-2">
                                <p:outputLabel value="Actualizar Imagen" styleClass="data-label" style="font-size: 0.65rem;" />
                                <p:fileUpload id="upload" value="#{adminBean.file}" mode="simple" skinSimple="true"
                                              accept="image/*" label="Seleccionar archivo" />
                            </div>
                        </h:panelGroup>
                    </p:outputPanel>

                    <f:facet name="footer">
                        <div class="d-flex justify-content-end gap-2 p-2">
                            <p:commandButton value="CANCELAR" onclick="PF('manageProductDialog').hide()" class="ui-button-flat ui-button-plain" />
                            <p:commandButton value="GUARDAR PRODUCTO" icon="pi pi-save" actionListener="#{adminBean.saveProduct}"
                                             update="manage-product-content :form:dt-products" styleClass="ui-button-warning fw-bold" />
                        </div>
                    </f:facet>
                </p:dialog>

                <p:confirmDialog widgetVar="deleteProductDialog" showEffect="fade" width="350"
                                 message="¿Desea eliminar permanentemente este producto del catálogo?"
                                 header="Confirmar Acción" severity="warn">
                    <p:commandButton value="ELIMINAR" icon="pi pi-trash" actionListener="#{adminBean.deleteProduct}"
                                     process="@this" update=":form" oncomplete="PF('deleteProductDialog').hide()" styleClass="ui-button-danger" />
                    <p:commandButton value="CANCELAR" type="button" styleClass="ui-button-flat ui-button-plain" onclick="PF('deleteProductDialog').hide()" />
                </p:confirmDialog>
            </h:form>
        </div>
    </ui:define>
</ui:composition>