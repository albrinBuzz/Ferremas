<?xml version="1.0" encoding="UTF-8"?>
<ui:composition lang="es"
                xmlns:f="jakarta.faces.core"
                xmlns:h="jakarta.faces.html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/template/main.xhtml">

    <ui:define name="contenido">
        <h:outputStylesheet>
            /* <![CDATA[ */
            .order-container { padding: 25px; max-width: 1400px; margin: 0 auto; }
            .badge-status { padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
            .status-pendiente { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
            .status-proceso { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); }
            .status-completado { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }

            .ui-datatable tr { background: #161b22 !important; border-bottom: 1px solid rgba(255,255,255,0.05) !important; }
            .ui-datatable thead th { background: #1c2128 !important; font-size: 0.7rem; color: rgba(255,255,255,0.5) !important; text-transform: uppercase; }
            .order-id { font-family: monospace; color: #fbbf24; font-weight: bold; }
            .detail-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; background: #fff; padding: 2px; }
            /* ]]> */
        </h:outputStylesheet>

        <div class="order-container">
            <h:form id="formPedidos">
                <p:growl id="msgs" showDetail="true" />

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-white fw-black m-0">Log√≠stica de Pedidos</h2>
                        <p class="text-muted small">Sucursal: <span class="text-warning">#{pedidoBean.sucursal.nombre}</span></p>
                    </div>

                    <div class="d-flex align-items-center gap-3">
                        <p:outputLabel for="estadoFiltro" value="FILTRAR POR:" styleClass="small text-muted fw-bold" />
                        <p:selectOneMenu id="estadoFiltro" value="#{pedidoBean.estadoFiltro}" style="width: 200px;">
                            <f:selectItem itemLabel="Todos los estados" itemValue="#{null}" noSelectionOption="true" />
                            <f:selectItems value="#{pedidoBean.estados}" var="estado"
                                           itemLabel="#{estado.nombre}" itemValue="#{estado.nombre}" />
                            <p:ajax event="change" update="tablaPedidos" oncomplete="PF('pedidoTable').filter()" />
                        </p:selectOneMenu>
                    </div>
                </div>

                <p:dataTable id="tablaPedidos" value="#{pedidoBean.pedidos}" var="pedido"
                             paginator="true" rows="10" widgetVar="pedidoTable"
                             paginatorPosition="bottom" reflow="true"
                             emptyMessage="No hay pedidos registrados en esta sucursal">

                    <p:column headerText="ID" style="width: 80px; text-align: center;">
                        <h:outputText value="#{pedido.idPedido}" styleClass="order-id" />
                    </p:column>

                    <p:column headerText="Fecha" sortBy="#{pedido.fecha}">
                        <h:outputText value="#{pedido.fecha}" styleClass="text-white small">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Estado" style="text-align: center;">
                        <span class="badge-status #{pedido.estadopedido.nombre eq 'Pendiente' ? 'status-pendiente' :
                                                   (pedido.estadopedido.nombre eq 'En Proceso' ? 'status-proceso' : 'status-completado')}">
                            #{pedido.estadopedido.nombre}
                        </span>
                    </p:column>

                    <p:column headerText="Cliente" filterBy="#{pedido.rutcliente}">
                        <h:outputText value="#{pedido.rutcliente}" styleClass="text-muted small" />
                    </p:column>

                    <p:column headerText="Total" sortBy="#{pedido.total}">
                        <h:outputText value="#{pedido.total}" styleClass="fw-bold text-white">
                            <f:convertNumber currencySymbol="$" type="currency" locale="es_CL" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Acciones" style="width: 120px; text-align: center;">
                        <p:commandButton icon="pi pi-sync" title="Cambiar Estado"
                                         action="#{pedidoBean.editarEstado(pedido)}"
                                         update=":formDialogs:dlgEstado"
                                         oncomplete="PF('dlgEstado').show()"
                                         styleClass="rounded-button ui-button-warning ui-button-flat"
                                         process="@this" />

                        <p:commandButton icon="pi pi-eye" title="Ver Detalle"
                                         action="#{pedidoBean.verDetallesPedido(pedido)}"
                                         update=":formDialogs:detalleDialog"
                                         oncomplete="PF('detalleDialog').show()"
                                         styleClass="rounded-button ui-button-info ui-button-flat ms-2"
                                         process="@this" />
                    </p:column>
                </p:dataTable>
            </h:form>

            <h:form id="formDialogs">

                <p:dialog id="dlgEstado" header="Actualizar Estado de Pedido" widgetVar="dlgEstado"
                          modal="true" responsive="true" width="400" styleClass="dark-dialog" showEffect="fade">

                    <p:outputPanel id="panelEstado" class="ui-fluid p-3 text-center">
                        <h:panelGroup rendered="#{not empty pedidoBean.pedidoSeleccionado}">
                            <i class="pi pi-exclamation-circle text-warning mb-3" style="font-size: 2rem;"></i>
                            <p class="text-white small mb-4">Actualizar flujo para el pedido: <b class="text-warning">##{pedidoBean.pedidoSeleccionado.idPedido}</b></p>

                            <p:selectOneMenu id="nuevoEstado" value="#{pedidoBean.estadoSeleccionadoID}">
                                <f:selectItems value="#{pedidoBean.estados}" var="est"
                                               itemLabel="#{est.nombre}" itemValue="#{est.idEstadopedido}" />
                            </p:selectOneMenu>

                            <div class="d-flex justify-content-center gap-2 mt-4">
                                <p:commandButton value="Cancelar" onclick="PF('dlgEstado').hide()" type="button" styleClass="ui-button-flat ui-button-plain" />
                                <p:commandButton value="Confirmar" action="#{pedidoBean.guardarEstado}"
                                                 update=":formPedidos:tablaPedidos :formPedidos:msgs"
                                                 oncomplete="PF('dlgEstado').hide()" styleClass="ui-button-warning fw-bold" />
                            </div>
                        </h:panelGroup>
                    </p:outputPanel>
                </p:dialog>

                <p:dialog id="detalleDialog" header="Ficha de Pedido" widgetVar="detalleDialog"
                          modal="true" responsive="true" width="750" styleClass="dark-dialog" showEffect="fade">

                    <p:outputPanel id="panelDetalle" class="p-2">
                        <p:dataTable value="#{pedidoBean.detallesPedido}" var="detalle" styleClass="ui-datatable-sm">
                            <p:column style="width: 60px; text-align: center;">
                                <p:graphicImage url="/imagenes/#{detalle.producto.imagen}" styleClass="detail-img"
                                                rendered="#{not empty detalle.producto.imagen}" />
                                <i class="pi pi-box text-muted" rendered="#{empty detalle.producto.imagen}" />
                            </p:column>

                            <p:column headerText="Producto">
                                <h:outputText value="#{detalle.producto.nombre}" styleClass="fw-bold text-white small" />
                            </p:column>

                            <p:column headerText="Cant." style="width: 70px; text-align: center;">
                                <span class="badge bg-secondary">#{detalle.cantidad}</span>
                            </p:column>

                            <p:column headerText="Precio" style="text-align: right;">
                                <h:outputText value="#{detalle.producto.precio}">
                                    <f:convertNumber currencySymbol="$" type="currency" locale="es_CL" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Subtotal" style="text-align: right;">
                                <h:outputText value="#{detalle.cantidad * detalle.producto.precio}" styleClass="text-warning fw-bold">
                                    <f:convertNumber currencySymbol="$" type="currency" locale="es_CL" />
                                </h:outputText>
                            </p:column>
                        </p:dataTable>

                        <div class="mt-4 p-3 border-top border-secondary text-end">
                            <h:outputText value="TOTAL: " styleClass="text-muted me-2 small fw-bold" />
                            <h:outputText value="#{pedidoBean.pedidoSeleccionado.total}" styleClass="text-white fs-4 fw-black">
                                <f:convertNumber currencySymbol="$" type="currency" locale="es_CL" />
                            </h:outputText>
                        </div>
                    </p:outputPanel>
                </p:dialog>
            </h:form>
        </div>
    </ui:define>
</ui:composition>